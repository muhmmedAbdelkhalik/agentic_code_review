#!/bin/bash
#
# Git pre-push hook for LocalAI Code Review Agent
#
# This hook runs the code review agent before pushing code to remote.
# It can optionally block pushes if critical issues are found.
#
# Installation:
#   Run: ./install_hooks.sh
#   Or manually: cp hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push
#
# Configuration:
#   Set BLOCK_ON_CRITICAL=true in .env to block pushes on critical issues
#   Set SKIP_REVIEW=1 environment variable to skip review for this push
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if review should be skipped
if [ -n "$SKIP_REVIEW" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Skipping code review (SKIP_REVIEW is set)${NC}"
    exit 0
fi

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python 3 is required but not installed${NC}"
    exit 1
fi

# Check if review_local.py exists
if [ ! -f "review_local.py" ]; then
    echo -e "${RED}‚ùå review_local.py not found${NC}"
    exit 1
fi

# Check if Ollama is running (or LocalAI)
if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1 && ! curl -s http://localhost:8080/readyz > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Neither Ollama nor LocalAI is running${NC}"
    echo -e "${YELLOW}   Start Ollama with: ollama serve${NC}"
    echo -e "${YELLOW}   Or start LocalAI with: docker-compose up -d${NC}"
    echo -e "${YELLOW}   Or skip review with: SKIP_REVIEW=1 git push${NC}"
    exit 1
fi

echo -e "${CYAN}ü§ñ Running LocalAI Code Review Agent...${NC}"
echo ""

# Determine commit range from git hook stdin (if available)
# Git pre-push hook provides: <local_ref> <local_sha1> <remote_ref> <remote_sha1>
COMMIT_RANGE=""
if [ -t 0 ]; then
    # No stdin (running manually), review uncommitted changes
    COMMIT_RANGE=""
else
    # Read from stdin to get commit range
    while read local_ref local_sha remote_ref remote_sha; do
        if [ -n "$local_sha" ] && [ -n "$remote_sha" ] && [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
            # Review commits being pushed
            if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
                # New branch, review all commits
                COMMIT_RANGE="$remote_sha..$local_sha"
            else
                # Review commits between remote and local
                COMMIT_RANGE="$remote_sha..$local_sha"
            fi
            break
        fi
    done
fi

# Run the review agent with commit range if available
if [ -n "$COMMIT_RANGE" ]; then
    echo -e "${CYAN}üìù Reviewing commits: $COMMIT_RANGE${NC}"
    REVIEW_CMD="python3 review_local.py --commit-range $COMMIT_RANGE"
else
    REVIEW_CMD="python3 review_local.py"
fi

if eval "$REVIEW_CMD"; then
    echo ""
    echo -e "${GREEN}‚úÖ Code review completed successfully${NC}"
    
    # Check if review file was created
    if [ -f ".local_review.json" ]; then
        # Extract summary using Python (more reliable than jq)
        SUMMARY=$(python3 -c "import json; print(json.load(open('.local_review.json'))['summary'])" 2>/dev/null || echo "Review completed")
        echo -e "${CYAN}üìã Summary: ${SUMMARY}${NC}"
        
        # Check for critical issues if blocking is enabled (from config.yaml or .env)
        BLOCK_ENABLED=false
        if [ -f ".env" ] && grep -q "BLOCK_ON_CRITICAL=true" .env; then
            BLOCK_ENABLED=true
        elif python3 -c "import yaml; config = yaml.safe_load(open('config.yaml')); print('true' if config.get('review', {}).get('block_on_critical', False) else 'false')" 2>/dev/null | grep -q "true"; then
            BLOCK_ENABLED=true
        fi
        
        if [ "$BLOCK_ENABLED" = "true" ]; then
            # Count critical and high severity issues (high can also be blocking)
            CRITICAL_COUNT=$(python3 -c "import json; issues = json.load(open('.local_review.json'))['issues']; print(len([i for i in issues if i.get('severity') == 'critical']))" 2>/dev/null || echo "0")
            HIGH_COUNT=$(python3 -c "import json; issues = json.load(open('.local_review.json'))['issues']; print(len([i for i in issues if i.get('severity') == 'high']))" 2>/dev/null || echo "0")
            TOTAL_BLOCKING=$((CRITICAL_COUNT + HIGH_COUNT))
            
            if [ "$TOTAL_BLOCKING" -gt 0 ]; then
                echo ""
                echo -e "${RED}üö´ BLOCKING PUSH: $CRITICAL_COUNT critical + $HIGH_COUNT high severity issue(s) found${NC}"
                echo -e "${RED}   Fix these issues or skip review with: SKIP_REVIEW=1 git push${NC}"
                echo ""
                echo -e "${YELLOW}Issues found:${NC}"
                python3 -c "
import json
data = json.load(open('.local_review.json'))
for issue in data.get('issues', []):
    if issue.get('severity') in ['critical', 'high']:
        print(f\"  ‚Ä¢ {issue.get('severity').upper()}: {issue.get('file', 'unknown')}:{issue.get('line', 0)} - {issue.get('type', 'unknown')}\")
        print(f\"    {issue.get('message', '')[:70]}\")
" 2>/dev/null || true
                exit 1
            fi
        fi
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ Push allowed${NC}"
    exit 0
else
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Code review failed or returned errors${NC}"
    echo -e "${YELLOW}   Check .local_review.log for details${NC}"
    echo -e "${YELLOW}   Skip review with: SKIP_REVIEW=1 git push${NC}"
    
    # Don't block push on review failure (only on critical issues)
    # Change this to 'exit 1' if you want to block on any failure
    exit 0
fi

